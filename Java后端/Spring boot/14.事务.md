Spring Boot é€šè¿‡ Spring Framework çš„å¼ºå¤§æ”¯æŒï¼Œè®©æ•°æ®åº“äº‹åŠ¡ç®¡ç†å˜å¾—å¼‚å¸¸ç®€å•ã€‚å®ƒä¸»è¦æä¾›äº†**å£°æ˜å¼äº‹åŠ¡**å’Œ**ç¼–ç¨‹å¼äº‹åŠ¡**ä¸¤ç§æ–¹å¼ï¼Œå¸®åŠ©ä½ ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚

ä¸‹é¢è¿™ä¸ªè¡¨æ ¼å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿäº†è§£ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼çš„æ ¸å¿ƒåŒºåˆ«ã€‚

|ç‰¹æ€§|å£°æ˜å¼äº‹åŠ¡|ç¼–ç¨‹å¼äº‹åŠ¡|
|---|---|---|
|**å®ç°æ–¹å¼**â€‹|ä½¿ç”¨ `@Transactional`æ³¨è§£|ä½¿ç”¨ `TransactionTemplate`æˆ– `PlatformTransactionManager`|
|**æ ¸å¿ƒåŸç†**â€‹|åŸºäº Spring AOP åŠ¨æ€ä»£ç†|åœ¨ä»£ç ä¸­æ˜¾å¼ç¼–å†™äº‹åŠ¡é€»è¾‘|
|**ä»£ç ä¾µå…¥æ€§**â€‹|æ— ä¾µå…¥ï¼Œç®€æ´ä¼˜é›…|ä¾µå…¥æ€§å¼ºï¼Œä»£ç ç›¸å¯¹ç¹ç|
|**çµæ´»æ€§**â€‹|è¾ƒå¥½ï¼Œå¯é€šè¿‡æ³¨è§£å±æ€§é…ç½®|æé«˜ï¼Œå¯ç²¾ç¡®æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ|
|**é€‚ç”¨åœºæ™¯**â€‹|ç»å¤§å¤šæ•°å¸¸è§„ä¸šåŠ¡åœºæ™¯|éœ€è¦ç²¾ç»†æ§åˆ¶äº‹åŠ¡çš„å¤æ‚åœºæ™¯|

### ğŸ’¡ å£°æ˜å¼äº‹åŠ¡è¯¦è§£

å£°æ˜å¼äº‹åŠ¡æ˜¯ **Spring Boot æ¨èä¸”æœ€å¸¸ç”¨çš„æ–¹å¼**ï¼Œé€šè¿‡åœ¨æ–¹æ³•æˆ–ç±»ä¸Šæ·»åŠ  `@Transactional`æ³¨è§£å³å¯å®ç°ã€‚

#### 1. åŸºæœ¬ä½¿ç”¨

ç¡®ä¿åœ¨åº”ç”¨å…¥å£ç±»æˆ–é…ç½®ç±»ä¸Šæ·»åŠ äº† `@EnableTransactionManagement`æ³¨è§£ï¼ˆSpring Boot é€šå¸¸ä¼šè‡ªåŠ¨é…ç½®ï¼‰ã€‚åœ¨ Service å±‚çš„æ–¹æ³•ä¸Šä½¿ç”¨ `@Transactional`ï¼š

```
@Service
public class OrderService {

    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private InventoryRepository inventoryRepository;

    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        inventoryRepository.decrementStock(order.getProductId(), order.getQuantity());
    }
}
```

å½“ `createOrder`æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨å¼€å¯äº‹åŠ¡ã€‚å¦‚æœæ–¹æ³•æ‰§è¡ŒæˆåŠŸåˆ™æäº¤ï¼Œå¦‚æœæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼ˆRuntimeExceptionï¼‰åˆ™å›æ»šã€‚

#### 2. æ³¨è§£å±æ€§é…ç½®

`@Transactional`æ³¨è§£æä¾›äº†å¤šä¸ªå±æ€§æ¥ç²¾ç¡®æ§åˆ¶äº‹åŠ¡è¡Œä¸ºï¼š

- **ä¼ æ’­è¡Œä¸ºï¼ˆpropagationï¼‰**ï¼šå®šä¹‰äº†äº‹åŠ¡æ–¹æ³•åœ¨ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡è¯¥å¦‚ä½•åˆ›å»ºæˆ–åŠ å…¥ã€‚å¸¸ç”¨å€¼åŒ…æ‹¬ï¼š
    
    - ==`REQUIRED==`ï¼ˆé»˜è®¤ï¼‰ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦åˆ™æ–°å»ºä¸€ä¸ªã€‚
        
    - ==`REQUIRES_NEW`ï¼šæ€»æ˜¯æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼Œå¦‚æœå½“å‰æœ‰äº‹åŠ¡åˆ™å°†å…¶æŒ‚èµ·ã€‚==
        
    - `NESTED`ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œã€‚
        

- **é»˜è®¤é€‰æ‹© `REQUIRED`**ï¼šå¯¹äºç»å¤§å¤šæ•°æ ‡å‡†çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™æ˜¯å®‰å…¨ä¸”é«˜æ•ˆçš„é€‰æ‹©ã€‚
    
- **ä»…åœ¨éœ€è¦â€œäº‹åŠ¡éš”ç¦»â€æ—¶é€‰æ‹© `REQUIRES_NEW`**ï¼šé—®è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼šâ€œè¿™ä¸ªæ“ä½œï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰æ˜¯å¦é‡è¦åˆ°å³ä½¿ä¸»ä¸šåŠ¡å¤±è´¥ï¼Œä¹Ÿå¿…é¡»æˆåŠŸä¿å­˜ï¼Ÿâ€ å¦‚æœç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œå†è€ƒè™‘ `REQUIRES_NEW`ã€‚

- **éš”ç¦»çº§åˆ«ï¼ˆisolationï¼‰**ï¼šè§£å†³å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶å¯èƒ½å¼•å‘çš„é—®é¢˜ï¼ˆå¦‚è„è¯»ã€å¹»è¯»ï¼‰ã€‚
    
    - å¸¸ç”¨çº§åˆ«æœ‰ `READ_COMMITTED`ï¼ˆæ¨èï¼Œé¿å…è„è¯»ï¼‰å’Œ `REPEATABLE_READ`ç­‰ã€‚
        
    
- **å›æ»šè§„åˆ™ï¼ˆrollbackFor/noRollbackForï¼‰**ï¼šé»˜è®¤ä»…åœ¨é‡åˆ°è¿è¡Œæ—¶å¼‚å¸¸å’Œé”™è¯¯ï¼ˆErrorï¼‰æ—¶å›æ»šã€‚è‹¥éœ€åœ¨==æ£€æŸ¥å‹å¼‚å¸¸==ï¼ˆå¦‚ `Exception`ï¼‰æ—¶ä¹Ÿå›æ»šï¼Œéœ€æ˜ç¡®æŒ‡å®šï¼š
    
    ```
    @Transactional(rollbackFor = Exception.class)
    public void someMethod() throws Exception {
        // ...
    }
    ```
    
- **åªè¯»ï¼ˆreadOnlyï¼‰**ï¼šæ ‡è®°ä¸º `true`å¯ä¼˜åŒ–æŸ¥è¯¢æ“ä½œï¼Œå¦‚ `@Transactional(readOnly = true)`ã€‚
    
- **è¶…æ—¶ï¼ˆtimeoutï¼‰**ï¼šæŒ‡å®šäº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œè¶…æ—¶åˆ™è‡ªåŠ¨å›æ»šã€‚
    

### âš™ï¸ ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†

å½“å£°æ˜å¼äº‹åŠ¡çš„çµæ´»æ€§æ— æ³•æ»¡è¶³æå…¶å¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œå¯è€ƒè™‘ç¼–ç¨‹å¼äº‹åŠ¡ã€‚

#### 1. ä½¿ç”¨ TransactionTemplateï¼ˆæ¨èï¼‰

`TransactionTemplate`ç®€åŒ–äº†ç¼–ç¨‹å¼äº‹åŠ¡çš„ä½¿ç”¨ã€‚

```
@Service
public class UserService {

    @Autowired
    private TransactionTemplate transactionTemplate;
    @Autowired
    private UserRepository userRepository;

    public void complexOperation() {
        transactionTemplate.execute(status -> {
            try {
                // ä¸€ç³»åˆ—æ•°æ®åº“æ“ä½œ
                userRepository.save(user1);
                userRepository.save(user2);
                return null; // æˆ–è¿”å›ç»“æœ
            } catch (Exception e) {
                status.setRollbackOnly(); // æ ‡è®°å›æ»š
                throw e;
            }
        });
    }
}
```

#### 2. ä½¿ç”¨ PlatformTransactionManager

è¿™ç§æ–¹å¼æä¾›äº†æœ€åº•å±‚çš„æ§åˆ¶ï¼Œä½†ä»£ç æœ€ä¸ºç¹çã€‚

```
@Service
public class UserService {

    @Autowired
    private PlatformTransactionManager transactionManager;
    @Autowired
    private UserRepository userRepository;

    public void complexOperation() {
        // å®šä¹‰äº‹åŠ¡å±æ€§
        DefaultTransactionDefinition definition = new DefaultTransactionDefinition();
        definition.setPropagationBehavior(Propagation.REQUIRED.value());
        // å¼€å¯äº‹åŠ¡
        TransactionStatus status = transactionManager.getTransaction(definition);

        try {
            // ä¸šåŠ¡æ“ä½œ
            userRepository.save(user1);
            userRepository.save(user2);
            // æäº¤äº‹åŠ¡
            transactionManager.commit(status);
        } catch (Exception e) {
            // å›æ»šäº‹åŠ¡
            transactionManager.rollback(status);
            throw e;
        }
    }
}
```

### âš ï¸ äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„å¸¸è§åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ

1. **è‡ªè°ƒç”¨é—®é¢˜**ï¼š**ç±»å†…éƒ¨æ–¹æ³•**è°ƒç”¨å¦ä¸€ä¸ªæœ‰ `@Transactional`æ³¨è§£çš„æ–¹æ³•ï¼Œäº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºä»£ç†æ— æ³•ä»‹å…¥ã€‚
    
    - **è§£å†³**ï¼šå°†äº‹åŠ¡æ–¹æ³•ç§»åˆ°å¦ä¸€ä¸ª Bean ä¸­ï¼Œæˆ–é€šè¿‡ `AopContext.currentProxy()`è·å–ä»£ç†å¯¹è±¡å†è°ƒç”¨ã€‚
        
    
2. **å¼‚å¸¸è¢«æ•è·**ï¼šå¦‚æœåœ¨æ–¹æ³•å†…æ•è·äº†å¼‚å¸¸ä¸”æ²¡æœ‰é‡æ–°æŠ›å‡ºï¼Œäº‹åŠ¡æ‹¦æˆªå™¨å°†æ— æ³•æ„ŸçŸ¥å¼‚å¸¸ï¼Œä»è€Œä¸ä¼šå›æ»šã€‚
    
    - **è§£å†³**ï¼šç¡®ä¿å¼‚å¸¸èƒ½æŠ›å‡ºç»™äº‹åŠ¡æ‹¦æˆªå™¨ï¼Œæˆ–åœ¨æ•è·åè°ƒç”¨ `TransactionAspectSupport.currentTransactionStatus().setRollbackOnly()`æ‰‹åŠ¨å›æ»šã€‚
        
    
3. **é public æ–¹æ³•**ï¼š`@Transactional`æ³¨è§£åªèƒ½ç”¨äº public æ–¹æ³•ã€‚
    
4. **æ•°æ®åº“å¼•æ“ä¸æ”¯æŒ**ï¼šå¦‚ MySQL çš„ MyISAM å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ï¼Œéœ€ä½¿ç”¨ InnoDBã€‚
    

### ğŸ’ æœ€ä½³å®è·µæ€»ç»“

- **ä¼˜å…ˆä½¿ç”¨å£°æ˜å¼äº‹åŠ¡**ï¼šä»£ç ç®€æ´ï¼Œèƒ½æ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚ã€‚
    
- **äº‹åŠ¡æ³¨è§£åº”åŠ åœ¨ Service å±‚**ï¼šè¿™æ˜¯ä¸šåŠ¡é€»è¾‘çš„è¾¹ç•Œã€‚
    
- **ä¿æŒäº‹åŠ¡æ–¹æ³•ç®€çŸ­**ï¼šé¿å…åœ¨äº‹åŠ¡ä¸­è¿›è¡Œè¿œç¨‹è°ƒç”¨ã€æ–‡ä»¶æ“ä½œç­‰è€—æ—¶è¡Œä¸ºã€‚
    
- **æ˜ç¡®æŒ‡å®šå›æ»šå¼‚å¸¸**ï¼šæ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œä½¿ç”¨ `rollbackFor`å±æ€§ã€‚
    
- **è°¨æ…é€‰æ‹©ä¼ æ’­è¡Œä¸º**ï¼šç†è§£ä¸åŒä¼ æ’­è¡Œä¸ºçš„è¯­ä¹‰ï¼Œ`REQUIRED`é€šå¸¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚
    

å¸Œæœ›è¿™ä»½è¯¦ç»†çš„æ¢³ç†èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨ Spring Boot äº‹åŠ¡ã€‚å¦‚æœä½ æœ‰ç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯æˆ–é‡åˆ°å…·ä½“é—®é¢˜ï¼Œæˆ‘å¾ˆä¹æ„æä¾›æ›´è¿›ä¸€æ­¥çš„å»ºè®®ã€‚
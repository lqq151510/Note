åœ¨Java Webå¼€å‘ä¸­ï¼Œ**æ‹¦æˆªå™¨**ã€å…¶**é…ç½®æ–¹æ³•**ä¸ **JWTä»¤ç‰Œ**çš„ç»“åˆä½¿ç”¨ï¼Œæ˜¯æ„å»ºå®‰å…¨ã€å¯æ§åº”ç”¨çš„å…³é”®ã€‚ä¸‹é¢æˆ‘å°†é€šè¿‡ä¸€ä¸ªæ¸…æ™°çš„æµç¨‹å’Œå…·ä½“ç¤ºä¾‹ï¼Œä¸ºæ‚¨è¯¦è§£å¦‚ä½•é…ç½®ä¸€ä¸ªç”¨äºJWTè®¤è¯çš„æ‹¦æˆªå™¨ã€‚

### ğŸ”§ æ‹¦æˆªå™¨é…ç½®çš„ä¸¤ç§æ ¸å¿ƒæ–¹å¼

æ‹¦æˆªå™¨çš„é…ç½®ä¸»è¦æœ‰ä¸¤ç§ä¸»æµæ–¹æ³•ï¼Œä¸‹è¡¨å±•ç¤ºäº†å®ƒä»¬çš„æ ¸å¿ƒåŒºåˆ«ï¼Œå¸®åŠ©æ‚¨æ ¹æ®é¡¹ç›®æƒ…å†µåšé€‰æ‹©ã€‚

|é…ç½®æ–¹å¼|æ ¸å¿ƒæè¿°|é€‚ç”¨åœºæ™¯|
|---|---|---|
|**Javaé…ç½®ï¼ˆæ¨èï¼‰**â€‹|é€šè¿‡å®ç° `WebMvcConfigurer`æ¥å£å¹¶é‡å†™ `addInterceptors`æ–¹æ³•æ¥åŠ¨æ€æ³¨å†Œæ‹¦æˆªå™¨ã€‚|**Spring Booté¡¹ç›®**ï¼Œè¿½æ±‚ç®€æ´ã€æ— éœ€XMLé…ç½®çš„ç°ä»£åº”ç”¨ã€‚|
|**XMLé…ç½®**â€‹|åœ¨ `spring-mvc.xml`ç­‰é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ `<mvc:interceptors>`æ ‡ç­¾è¿›è¡Œå£°æ˜å¼é…ç½®ã€‚|ä¼ ç»Ÿçš„ã€ä½¿ç”¨XMLæ–‡ä»¶è¿›è¡Œé›†ä¸­é…ç½®çš„Spring MVCé¡¹ç›®ã€‚|

å¯¹äºå¤§å¤šæ•°æ–°é¡¹ç›®ï¼Œæ›´æ¨èä½¿ç”¨ **Javaé…ç½®**ï¼Œå› ä¸ºå®ƒæ›´çµæ´»ã€ç±»å‹å®‰å…¨ï¼Œä¸”ä¸Spring Bootæ— ç¼é›†æˆã€‚

### ğŸš€ å®æˆ˜ï¼šé…ç½®JWTè®¤è¯æ‹¦æˆªå™¨

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œéœ€è¦å¯¹æ¥å‰ç«¯ï¼ŒåŸºäºJWTè¿›è¡Œç”¨æˆ·è®¤è¯ã€‚ä»¥ä¸‹æ˜¯å®ç°æ­¥éª¤ã€‚

**ç¬¬1æ­¥ï¼šåˆ›å»ºJWTå·¥å…·ç±»**

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·ç±»æ¥ç”Ÿæˆå’Œè§£æJWTä»¤ç‰Œã€‚

```
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import java.util.Date;
import java.util.Map;

public class JwtUtil {
    private static final String SECRET_KEY = "your-very-secure-secret-key"; // ç”Ÿäº§ç¯å¢ƒåº”ä»å®‰å…¨é…ç½®è¯»å–
    private static final long EXPIRATION_TIME = 86400000; // ä»¤ç‰Œæœ‰æ•ˆæœŸï¼š24å°æ—¶

    // ç”ŸæˆJWT
    public static String generateToken(Map<String, Object> claims) {
        return Jwts.builder()
                .setClaims(claims) // è®¾ç½®è‡ªå®šä¹‰æ•°æ®ï¼ˆå¦‚ç”¨æˆ·IDï¼‰
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(SignatureAlgorithm.HS256, SECRET_KEY)
                .compact();
    }

    // è§£æå¹¶éªŒè¯JWT
    public static Claims parseToken(String token) {
        return Jwts.parser()
                .setSigningKey(SECRET_KEY)
                .parseClaimsJws(token)
                .getBody();
    }
}
```

**ç¬¬2æ­¥ï¼šå®ç°JWTè®¤è¯æ‹¦æˆªå™¨**

æ¥ä¸‹æ¥ï¼Œåˆ›å»ºæ ¸å¿ƒçš„æ‹¦æˆªå™¨ï¼Œåœ¨è¯·æ±‚åˆ°è¾¾Controllerå‰éªŒè¯JWTã€‚

```
@Component
public class JwtAuthenticationInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response, 
                             Object handler) throws Exception {
        // 1. æ£€æŸ¥æ˜¯å¦ä¸ºControlleræ–¹æ³•ï¼ˆé™æ€èµ„æºç›´æ¥æ”¾è¡Œï¼‰
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }

        // 2. ä»HTTPè¯·æ±‚å¤´ä¸­è·å–Tokenï¼ˆé€šå¸¸æ”¾åœ¨Authorizationå¤´ä¸­ï¼‰
        String token = request.getHeader("Authorization");
        if (token == null || !token.startsWith("Bearer ")) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.getWriter().write("Missing or invalid token");
            return false;
        }
        token = token.substring(7); // å»æ‰"Bearer "å‰ç¼€

        // 3. éªŒè¯Token
        try {
            Claims claims = JwtUtil.parseToken(token);
            Long userId = claims.get("userId", Long.class);
            // å°†è§£æå‡ºçš„ç”¨æˆ·ä¿¡æ¯å­˜å…¥çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¾›Controllerä½¿ç”¨
            UserContext.setCurrentUserId(userId);
            return true; // éªŒè¯é€šè¿‡ï¼Œæ”¾è¡Œ
        } catch (Exception e) {
            // Tokenæ— æ•ˆï¼ˆè¿‡æœŸã€ç­¾åé”™è¯¯ç­‰ï¼‰
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.getWriter().write("Invalid token");
            return false;
        }
    }

    @Override
    public void afterCompletion(HttpServletRequest request, 
                                HttpServletResponse response, 
                                Object handler, Exception ex) {
        // è¯·æ±‚å®Œæˆåï¼Œæ¸…ç†çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        UserContext.clear();
    }
}
```

**ç¬¬3æ­¥ï¼šæ³¨å†Œæ‹¦æˆªå™¨å¹¶é…ç½®æ‹¦æˆªè§„åˆ™**

æœ€åï¼Œé€šè¿‡é…ç½®ç±»å°†æ‹¦æˆªå™¨æ³¨å†Œåˆ°Spring MVCä¸­ï¼Œå¹¶æŒ‡å®šå®ƒè¦æ‹¦æˆªå’Œæ’é™¤çš„è·¯å¾„ã€‚

```
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Autowired
    private JwtAuthenticationInterceptor jwtInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtInterceptor)
                .addPathPatterns("/api/**")       // æ‹¦æˆªæ‰€æœ‰ä»¥/api/å¼€å¤´çš„è¯·æ±‚
                .excludePathPatterns(             // æ’é™¤ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„
                    "/api/auth/login", 
                    "/api/auth/register",
                    "/public/**"
                );
    }
}
```

### ğŸ’¡ é«˜çº§é…ç½®ä¸æœ€ä½³å®è·µ

1. **ç²¾ç»†åŒ–çš„è·¯å¾„ç®¡ç†**ï¼šä½¿ç”¨ `addPathPatterns()`å’Œ `excludePathPatterns()`å¯ä»¥ç²¾ç¡®æ§åˆ¶æ‹¦æˆªèŒƒå›´ï¼Œç¡®ä¿ç™»å½•ã€æ³¨å†Œç­‰å…¬å¼€æ¥å£ä¸è¢«æ‹¦æˆªã€‚
    
2. **å¤„ç†å¤šä¸ªæ‹¦æˆªå™¨**ï¼šå¦‚æœé¡¹ç›®æœ‰å¤šä¸ªæ‹¦æˆªå™¨ï¼ˆå¦‚æ—¥å¿—æ‹¦æˆªå™¨ã€æƒé™æ‹¦æˆªå™¨ï¼‰ï¼Œå¯ä»¥é€šè¿‡ `order()`æ–¹æ³•æŒ‡å®šæ‰§è¡Œé¡ºåºï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚
    
    ```
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LoggingInterceptor()).order(1);
        registry.addInterceptor(jwtInterceptor).order(2);
    }
    ```
    
3. **çº¿ç¨‹å®‰å…¨ä¸èµ„æºæ¸…ç†**ï¼šåœ¨ `preHandle`ä¸­å­˜å‚¨äºçº¿ç¨‹å±€éƒ¨å˜é‡ï¼ˆ`ThreadLocal`ï¼‰çš„ç”¨æˆ·ä¿¡æ¯ï¼ŒåŠ¡å¿…åœ¨ `afterCompletion`ä¸­æ¸…ç†ï¼Œè¿™æ˜¯é¿å…å†…å­˜æ³„æ¼çš„å…³é”®ã€‚
    
4. **ç»“åˆæ³¨è§£å®ç°æ›´ç»†ç²’åº¦æ§åˆ¶**ï¼šå¯ä»¥è‡ªå®šä¹‰æ³¨è§£ï¼ˆå¦‚ `@NoAuth`ï¼‰ï¼Œåœ¨æ‹¦æˆªå™¨ä¸­åˆ¤æ–­è‹¥æ–¹æ³•ä¸Šæœ‰æ­¤æ³¨è§£åˆ™ç›´æ¥æ”¾è¡Œï¼Œå®ç°æ–¹æ³•çº§åˆ«çš„çµæ´»æ§åˆ¶ã€‚
    

### ğŸ’ æ€»ç»“

é€šè¿‡ **æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰**â€‹ é›†ä¸­å¤„ç† **JWTä»¤ç‰Œ**â€‹ çš„è®¤è¯é€»è¾‘ï¼Œæ˜¯ç°ä»£Java Webåº”ç”¨çš„æ ‡å‡†åšæ³•ã€‚å…¶æ ¸å¿ƒä¼˜åŠ¿åœ¨äºï¼š

- **èŒè´£æ¸…æ™°**ï¼šå°†è®¤è¯é€»è¾‘ä¸ä¸šåŠ¡ä»£ç åˆ†ç¦»ï¼Œä½¿Controlleræ›´ä¸“æ³¨äºå¤„ç†ä¸šåŠ¡ã€‚
    
- **ç»´æŠ¤æ–¹ä¾¿**ï¼šå®‰å…¨ç­–ç•¥çš„å˜æ›´åªéœ€ä¿®æ”¹æ‹¦æˆªå™¨ï¼Œæ— éœ€æ”¹åŠ¨å„ä¸ªæ¥å£ã€‚
    
- **çµæ´»å¯æ§**ï¼šé€šè¿‡è·¯å¾„é…ç½®å’Œæ³¨è§£ï¼Œå¯ä»¥è½»æ¾ç®¡ç†ä¸åŒæ¥å£çš„è®¤è¯éœ€æ±‚ã€‚
    

å¸Œæœ›è¿™ä»½è¯¦ç»†çš„æŒ‡å—èƒ½å¸®åŠ©æ‚¨é¡ºåˆ©åœ°åœ¨é¡¹ç›®ä¸­å®æ–½JWTæ‹¦æˆªå™¨ã€‚å¦‚æœæ‚¨åœ¨å…·ä½“ç¼–ç æˆ–é…ç½®ä¸­é‡åˆ°å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿éšæ—¶æå‡ºï¼
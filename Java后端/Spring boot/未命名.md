æˆ‘æ¥è¯¦ç»†åˆ†æThreadLocalåœ¨é¡¹ç›®ä¸­çš„åº”ç”¨ã€‚é¦–å…ˆè®©æˆ‘æŸ¥çœ‹ç›¸å…³ä»£ç æ–‡ä»¶ã€‚
        
            
toolName: view_files
            
status: success
          
            
filePath: d:\waimai\sky-take-out\sky-common\src\main\java\com\sky\context\BaseContext.java
          

        
            
toolName: search_by_regex
            
status: success
          
query: BaseContext\.
          
è®©æˆ‘ç»§ç»­æŸ¥çœ‹æ‹¦æˆªå™¨çš„å®Œæ•´å®ç°ï¼š
        
            
toolName: view_files
            
status: success
          
            
filePath: d:\waimai\sky-take-out\sky-server\src\main\java\com\sky\interceptor\JwtTokenAdminInterceptor.java
          

        
            
toolName: view_files
            
status: success
          
            
filePath: d:\waimai\sky-take-out\sky-server\src\main\java\com\sky\interceptor\JwtTokenUserInterceptor.java
          

        
            
toolName: view_files
            
status: success
          
            
filePath: d:\waimai\sky-take-out\sky-server\src\main\java\com\sky\aspect\AutoFillAspect.java
          
è®©æˆ‘å†æŸ¥çœ‹ä¸€äº›å…·ä½“ä¸šåŠ¡åœºæ™¯ä¸­çš„ä½¿ç”¨ï¼š
        
            
toolName: view_files
            
status: success
          
            
filePath: d:\waimai\sky-take-out\sky-server\src\main\java\com\sky\service\impl\ShoppingCartServiceImpl.java
          

        
            
toolName: view_files
            
status: success
          
            
filePath: d:\waimai\sky-take-out\sky-server\src\main\java\com\sky\service\impl\EmployeeServiceImpl.java
          
ç°åœ¨æˆ‘å·²ç»å®Œæ•´åˆ†æäº†ThreadLocalåœ¨é¡¹ç›®ä¸­çš„åº”ç”¨ï¼Œä¸‹é¢ä¸ºæ‚¨è¯¦ç»†è§£é‡Šï¼š

---

## ThreadLocal åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨è¯¦è§£

### ä¸€ã€æ ¸å¿ƒå®ç°ç±»ï¼šBaseContext

é¡¹ç›®ä¸­ThreadLocalçš„å°è£…ä½äº [BaseContext.java](file:///d:/waimai/sky-take-out/sky-common/src/main/java/com/sky/context/BaseContext.java)ï¼š

```java
public class BaseContext {
    public static ThreadLocal<Long> threadLocal = new ThreadLocal<>();

    public static void setCurrentId(Long id) {
        threadLocal.set(id);
    }

    public static Long getCurrentId() {
        return threadLocal.get();
    }

    public static void removeCurrentId() {
        threadLocal.remove();
    }
}
```

### äºŒã€å·¥ä½œåŸç†å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           HTTP è¯·æ±‚å¤„ç†æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   HTTPè¯·æ±‚ â”€â”€â–º æ‹¦æˆªå™¨ â”€â”€â–º Controller â”€â”€â–º Service â”€â”€â–º Mapper â”€â”€â–º æ•°æ®åº“   â”‚
â”‚                     â”‚           â”‚           â”‚          â”‚                â”‚
â”‚                     â–¼           â–¼           â–¼          â–¼                â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚               â”‚ preHandleâ”‚                                         â”‚
â”‚               â”‚         â”‚                                         â”‚
â”‚               â”‚ 1.è§£æJWTâ”‚                                         â”‚
â”‚               â”‚ 2.è·å–ID â”‚                                         â”‚
â”‚               â”‚ 3.set()  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚    â”‚
â”‚                                                                â–¼    â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                                              â”‚   ThreadLocalç©ºé—´    â”‚â”‚
â”‚                                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚                                              â”‚  â”‚ Thread-1: ID=1  â”‚ â”‚â”‚
â”‚                                              â”‚  â”‚ Thread-2: ID=5  â”‚ â”‚â”‚
â”‚                                              â”‚  â”‚ Thread-3: ID=8  â”‚ â”‚â”‚
â”‚                                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                â”‚    â”‚
â”‚                                                                â–¼    â”‚
â”‚   HTTPå“åº” â—„â”€â”€ æ‹¦æˆªå™¨ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                     â”‚                                                   â”‚
â”‚                     â–¼                                                   â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚               â”‚ afterCompletion  â”‚                                     â”‚
â”‚               â”‚                  â”‚                                     â”‚
â”‚               â”‚  remove() æ¸…ç†   â”‚                                     â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‰ã€å…·ä½“åº”ç”¨åœºæ™¯

#### åœºæ™¯1ï¼šJWTè®¤è¯æ‹¦æˆªå™¨ï¼ˆå…¥å£ç‚¹ï¼‰

**ç®¡ç†å‘˜æ‹¦æˆªå™¨** [JwtTokenAdminInterceptor.java](file:///d:/waimai/sky-take-out/sky-server/src/main/java/com/sky/interceptor/JwtTokenAdminInterceptor.java#L40-L68)ï¼š

```java
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
    // 1. ä»è¯·æ±‚å¤´è·å–JWT Token
    String token = request.getHeader(jwtProperties.getAdminTokenName());
    
    // 2. è§£æJWTè·å–ç”¨æˆ·ID
    Claims claims = JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);
    Long empId = Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());
    
    // 3. â˜… å­˜å…¥ThreadLocal â˜…
    BaseContext.setCurrentId(empId);
    return true;
}

@Override
public void afterCompletion(...) {
    // 4. â˜… è¯·æ±‚ç»“æŸåæ¸…ç† â˜…
    BaseContext.removeCurrentId();
}
```

#### åœºæ™¯2ï¼šä¸šåŠ¡å±‚è·å–å½“å‰ç”¨æˆ·

**è´­ç‰©è½¦æœåŠ¡** [ShoppingCartServiceImpl.java](file:///d:/waimai/sky-take-out/sky-server/src/main/java/com/sky/service/impl/ShoppingCartServiceImpl.java#L39)ï¼š

```java
public void addShoppingCart(ShoppingCartDTO shoppingCartDTO) {
    ShoppingCart shoppingCart = new ShoppingCart();
    // â˜… ç›´æ¥è·å–å½“å‰ç™»å½•ç”¨æˆ·IDï¼Œæ— éœ€ä¼ å‚ â˜…
    Long userId = BaseContext.getCurrentId();
    shoppingCart.setUserId(userId);
    // ... ä¸šåŠ¡é€»è¾‘
}
```

#### åœºæ™¯3ï¼šAOPè‡ªåŠ¨å¡«å……

**è‡ªåŠ¨å¡«å……åˆ‡é¢** [AutoFillAspect.java](file:///d:/waimai/sky-take-out/sky-server/src/main/java/com/sky/aspect/AutoFillAspect.java#L44)ï¼š

```java
@Before("autoFillPointcut(autoFill)")
public void autoFill(JoinPoint joinPoint, AutoFill autoFill) {
    // â˜… è·å–å½“å‰ç”¨æˆ·IDç”¨äºè‡ªåŠ¨å¡«å……åˆ›å»ºäºº/æ›´æ–°äºº â˜…
    Long currentId = BaseContext.getCurrentId();
    
    if (operationType == OperationType.INSERT) {
        setCreateUser.invoke(entity, currentId);
        setUpdateUser.invoke(entity, currentId);
    } else if (operationType == OperationType.UPDATE) {
        setUpdateUser.invoke(entity, currentId);
    }
}
```

### å››ã€è§£å†³çš„é—®é¢˜

| é—®é¢˜ | ä¼ ç»Ÿæ–¹æ¡ˆ | ThreadLocalæ–¹æ¡ˆ |
|------|---------|----------------|
| ç”¨æˆ·IDä¼ é€’ | æ¯å±‚æ–¹æ³•éƒ½éœ€è¦ä¼ userIdå‚æ•° | æ— éœ€ä¼ å‚ï¼Œéšå¤„å¯å– |
| ä»£ç è€¦åˆ | Controllerâ†’Serviceâ†’Mapperå±‚å±‚ä¼ é€’ | è§£è€¦ï¼Œå„å±‚ç‹¬ç«‹è·å– |
| è‡ªåŠ¨å¡«å…… | éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•æ‰‹åŠ¨è®¾ç½® | AOPåˆ‡é¢è‡ªåŠ¨å¤„ç† |
| çº¿ç¨‹å®‰å…¨ | å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®æ··ä¹± | æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ |

### äº”ã€é¡¹ç›®ä¸­çš„ä½¿ç”¨ç»Ÿè®¡

```
ä½¿ç”¨ä½ç½®                              ä½¿ç”¨æ¬¡æ•°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OrderServiceImpl.java                     5æ¬¡
ShoppingCartServiceImpl.java              4æ¬¡
EmployeeServiceImpl.java                  5æ¬¡
AddressBookController/ServiceImpl         4æ¬¡
CategoryServiceImpl.java                  3æ¬¡
AutoFillAspect.java                       1æ¬¡
JwtTokenAdminInterceptor.java             2æ¬¡
JwtTokenUserInterceptor.java              2æ¬¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                                     26æ¬¡
```

### å…­ã€æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

#### âš ï¸ å†…å­˜æ³„æ¼é£é™©

```java
// âŒ é”™è¯¯ï¼šå¿˜è®°æ¸…ç†
public boolean preHandle(...) {
    BaseContext.setCurrentId(empId);
    return true;
    // æ²¡æœ‰ afterCompletion æ¸…ç†ï¼
}

// âœ… æ­£ç¡®ï¼šå¿…é¡»æ¸…ç†
public boolean preHandle(...) {
    BaseContext.setCurrentId(empId);
    return true;
}

@Override
public void afterCompletion(...) {
    BaseContext.removeCurrentId();  // å¿…é¡»è°ƒç”¨ï¼
}
```

#### ğŸ”„ çº¿ç¨‹æ± åœºæ™¯æ³¨æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çº¿ç¨‹æ± å¤ç”¨é—®é¢˜                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  è¯·æ±‚1 â”€â”€â–º Thread-A â”€â”€â–º set(ID=1) â”€â”€â–º è¯·æ±‚ç»“æŸ             â”‚
â”‚                              â”‚                             â”‚
â”‚                              â–¼ (æœªæ¸…ç†)                    â”‚
â”‚  è¯·æ±‚2 â”€â”€â–º Thread-A â”€â”€â–º get() â”€â”€â–º è¿”å› ID=1 (é”™è¯¯!)        â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“‹ æœ€ä½³å®è·µæ¸…å•

1. **å¿…é¡»æ¸…ç†**ï¼šåœ¨æ‹¦æˆªå™¨çš„ `afterCompletion` ä¸­è°ƒç”¨ `remove()`
2. **ç©ºå€¼æ£€æŸ¥**ï¼šä½¿ç”¨å‰æ£€æŸ¥è¿”å›å€¼æ˜¯å¦ä¸ºnull
   ```java
   Long currentId = BaseContext.getCurrentId();
   if (currentId == null) {
       throw new BaseException(MessageConstant.USER_NOT_LOGIN);
   }
   ```
3. **ä¸è¦åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­ä½¿ç”¨**ï¼šå­çº¿ç¨‹æ— æ³•è·å–çˆ¶çº¿ç¨‹çš„ThreadLocalå€¼
4. **ä½¿ç”¨InheritableThreadLocal**ï¼šå¦‚éœ€çˆ¶å­çº¿ç¨‹ä¼ é€’ï¼Œå¯æ”¹ç”¨æ­¤ç±»

### ä¸ƒã€ä¸ºä»€ä¹ˆé€‰æ‹©ThreadLocal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ–¹æ¡ˆå¯¹æ¯”                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Session     â”‚    å‚æ•°ä¼ é€’     â”‚       ThreadLocal           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¾èµ–HTTPä¼šè¯    â”‚ ä»£ç å†—ä½™        â”‚ çº¿ç¨‹éš”ç¦»ï¼Œå®‰å…¨              â”‚
â”‚ ä¸é€‚åˆæ— çŠ¶æ€API â”‚ è€¦åˆåº¦é«˜        â”‚ æ— éœ€ä¼ å‚ï¼Œç®€æ´              â”‚
â”‚ åˆ†å¸ƒå¼é—®é¢˜      â”‚ ç»´æŠ¤å›°éš¾        â”‚ é€‚åˆå¾®æœåŠ¡æ¶æ„              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…«ã€æ€»ç»“

ThreadLocalåœ¨æœ¬é¡¹ç›®ä¸­çš„æ ¸å¿ƒä½œç”¨æ˜¯**åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ä¼ é€’ç”¨æˆ·èº«ä»½ä¿¡æ¯**ï¼Œå®ç°äº†ï¼š

1. **è§£è€¦**ï¼šä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒç”¨æˆ·IDä»ä½•è€Œæ¥
2. **å®‰å…¨**ï¼šçº¿ç¨‹éš”ç¦»ä¿è¯å¤šç”¨æˆ·å¹¶å‘å®‰å…¨
3. **ç®€æ´**ï¼šé¿å…äº†å‚æ•°å±‚å±‚ä¼ é€’çš„æ ·æ¿ä»£ç 
4. **è‡ªåŠ¨åŒ–**ï¼šé…åˆAOPå®ç°å­—æ®µè‡ªåŠ¨å¡«å……
é€šè¿‡è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œä½ å¯ä»¥ç²¾ç»†æ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ï¼Œæœ‰æ•ˆç®¡ç†èµ„æºï¼Œé¿å…ç›²ç›®ä½¿ç”¨å†…ç½®çº¿ç¨‹æ± å¸¦æ¥çš„é£é™©ã€‚ä¸‹é¢è¿™ä¸ªè¡¨æ ¼æ±‡æ€»äº†å®ç°è‡ªå®šä¹‰çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å’Œæ‰©å±•ç‚¹ã€‚
[javaä¸­è‡ªå®šä¹‰çº¿ç¨‹æ± çš„å‚æ•°](obsidian://deepseek-ai-assistant?id=1770183495441 "Open plugin:deepseek-ai-assistant")

| é…ç½®ç»´åº¦       | æ ¸å¿ƒå‚æ•°/æ–¹æ³•                 | è¯´æ˜ä¸å»ºè®®                                                                                         |
| ---------- | ----------------------- | --------------------------------------------------------------------------------------------- |
| **æ ¸å¿ƒçº¿ç¨‹æ•°**â€‹ | `corePoolSize`          | çº¿ç¨‹æ± ä¿æŒçš„æœ€å°çº¿ç¨‹æ•°ï¼Œå³ä½¿ç©ºé—²ä¹Ÿä¸ä¼šé”€æ¯ï¼ˆé™¤éè®¾ç½®`allowCoreThreadTimeOut`ï¼‰ã€‚                                          |
| **æœ€å¤§çº¿ç¨‹æ•°**â€‹ | `maximumPoolSize`       | çº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çº¿ç¨‹ç›´åˆ°æ­¤ä¸Šé™ã€‚                                                          |
| **ç©ºé—²æ—¶é—´**â€‹  | `keepAliveTime`+ `unit` | å½“çº¿ç¨‹æ•°è¶…è¿‡`corePoolSize`æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶å°†è¢«ç»ˆæ­¢ã€‚                                               |
| **ä»»åŠ¡é˜Ÿåˆ—**â€‹  | `workQueue`             | ç”¨äºä¿å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¦‚`ArrayBlockingQueue`ï¼ˆæœ‰ç•Œï¼‰æˆ–`LinkedBlockingQueue`ï¼ˆå¯é€‰æœ‰ç•Œ/æ— ç•Œï¼‰ã€‚**æ¨èä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—**ä»¥é˜²æ­¢å†…å­˜è€—å°½ã€‚ |
| **çº¿ç¨‹å·¥å‚**â€‹  | `threadFactory`         | ç”¨äºåˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¯è‡ªå®šä¹‰çº¿ç¨‹åã€ä¼˜å…ˆçº§ç­‰ï¼Œä¾¿äºç›‘æ§å’Œè°ƒè¯•ã€‚                                                                 |
| **æ‹’ç»ç­–ç•¥**â€‹  | `handler`               | å½“çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½é¥±å’Œæ—¶å¦‚ä½•å¤„ç†æ–°ä»»åŠ¡ã€‚å†…ç½®ç­–ç•¥åŒ…æ‹¬æŠ›å‡ºå¼‚å¸¸ï¼ˆ`AbortPolicy`ï¼‰ã€ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹ç›´æ¥è¿è¡Œï¼ˆ`CallerRunsPolicy`ï¼‰ç­‰ã€‚               |

### ğŸ’¡ ä¸ºä½•è¦è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Ÿ

è™½ç„¶ `Executors`å·¥å…·ç±»æä¾›çš„ `newFixedThreadPool`ã€`newCachedThreadPool`ç­‰æ–¹æ³•å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒä»¬ä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—æˆ–é»˜è®¤é…ç½®ï¼Œåœ¨é«˜è´Ÿè½½ä¸‹å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºæˆ–åˆ›å»ºè¿‡å¤šçº¿ç¨‹ã€‚ç›´æ¥ä½¿ç”¨ `ThreadPoolExecutor`æ„é€ å‡½æ•°ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚ä»»åŠ¡ç±»å‹ã€ç³»ç»Ÿèµ„æºã€æ€§èƒ½è¦æ±‚ï¼‰è¿›è¡Œç²¾å‡†é…ç½®ï¼Œå®ç°æœ€ä¼˜çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚

### ğŸ› ï¸ å¦‚ä½•å®ç°è‡ªå®šä¹‰çº¿ç¨‹æ± 

#### åŸºç¡€åˆ›å»ºç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„è‡ªå®šä¹‰çº¿ç¨‹æ± åˆ›å»ºç¤ºä¾‹ï¼Œæ¶µç›–äº†æ ¸å¿ƒå‚æ•°ã€è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚å’Œæ‹’ç»ç­–ç•¥ã€‚

```
import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;

public class CustomThreadPoolDemo {

    public static void main(String[] args) {
        // 1. è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚ï¼šè®¾ç½®æ˜“äºè¯†åˆ«çš„çº¿ç¨‹åç§°
        ThreadFactory threadFactory = new ThreadFactory() {
            private final AtomicInteger threadNumber = new AtomicInteger(1);
            @Override
            public Thread newThread(Runnable r) {
                Thread t = new Thread(r, "CustomWorker-" + threadNumber.getAndIncrement());
                t.setPriority(Thread.NORM_PRIORITY);
                t.setDaemon(false); // è®¾ç½®ä¸ºéå®ˆæŠ¤çº¿ç¨‹ï¼Œé˜²æ­¢ä¸»çº¿ç¨‹é€€å‡ºå¯¼è‡´æ± ä¸­æ­¢
                return t;
            }
        };

        // 2. è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ï¼šè®°å½•æ—¥å¿—æˆ–æ‰§è¡Œå¤‡ç”¨æ–¹æ¡ˆ
        RejectedExecutionHandler rejectionHandler = new RejectedExecutionHandler() {
            @Override
            public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
                // ä¾‹å¦‚ï¼Œè®°å½•æ—¥å¿—ã€å›é€€åˆ°æ•°æ®åº“æˆ–ç”±è°ƒç”¨çº¿ç¨‹ç›´æ¥æ‰§è¡Œ
                System.err.println("Task rejected: " + r.toString());
                // å¯é€‰æ‹©æŠ›å‡ºå¼‚å¸¸ï¼šthrow new RejectedExecutionException("Task " + r.toString() + " rejected");
            }
        };

        // 3. åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹æ± 
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
            2,  // corePoolSize: æ ¸å¿ƒçº¿ç¨‹æ•°
            4,  // maximumPoolSize: æœ€å¤§çº¿ç¨‹æ•°
            60L, // keepAliveTime: éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´
            TimeUnit.SECONDS, // æ—¶é—´å•ä½
            new ArrayBlockingQueue<>(10), // workQueue: æœ‰ç•Œä»»åŠ¡é˜Ÿåˆ—ï¼Œå®¹é‡10
            threadFactory,    // è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚
            rejectionHandler  // è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥
        );

        // æäº¤ä»»åŠ¡ç¤ºä¾‹
        for (int i = 0; i < 15; i++) {
            final int taskId = i;
            executor.execute(() -> {
                System.out.println(Thread.currentThread().getName() + " æ‰§è¡Œä»»åŠ¡: " + taskId);
                try {
                    Thread.sleep(1000); // æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œ
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
        }

        // 4. ä¼˜é›…å…³é—­çº¿ç¨‹æ± ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
        executor.shutdown(); // åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡
        try {
            // ç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆï¼Œæœ€å¤šç­‰å¾…1åˆ†é’Ÿ
            if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                executor.shutdownNow(); // å¼ºåˆ¶å–æ¶ˆä»åœ¨ç­‰å¾…çš„ä»»åŠ¡
            }
        } catch (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

#### æ‰©å±•çº¿ç¨‹æ± åŠŸèƒ½

é€šè¿‡ç»§æ‰¿ `ThreadPoolExecutor`å¹¶é‡å†™å…¶é’©å­æ–¹æ³•ï¼Œå¯ä»¥å®ç°æ‰§è¡Œç›‘æ§ç­‰é«˜çº§åŠŸèƒ½ã€‚

```
public class MonitorableThreadPoolExecutor extends ThreadPoolExecutor {
    public MonitorableThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue<Runnable> workQueue) {
        super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue);
    }

    @Override
    protected void beforeExecute(Thread t, Runnable r) {
        super.beforeExecute(t, r);
        System.out.println("ä»»åŠ¡å¼€å§‹æ‰§è¡Œ: " + r.toString());
    }

    @Override
    protected void afterExecute(Runnable r, Throwable t) {
        super.afterExecute(r, t);
        if (t != null) {
            System.err.println("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸: " + t.getMessage());
        }
        System.out.println("ä»»åŠ¡æ‰§è¡Œç»“æŸ: " + r.toString());
    }

    @Override
    protected void terminated() {
        super.terminated();
        System.out.println("çº¿ç¨‹æ± å·²ç»ˆæ­¢");
    }
}
```

### ğŸ’¡ å…³é”®é…ç½®å»ºè®®

1. **ä»»åŠ¡ç±»å‹å†³å®šæ ¸å¿ƒå‚æ•°**
    
    - **CPUå¯†é›†å‹ä»»åŠ¡**ï¼ˆè®¡ç®—å¤æ‚ï¼‰ï¼šå»ºè®® `corePoolSize`è®¾ç½®ä¸º **CPUæ ¸æ•° + 1**ï¼Œé¿å…è¿‡å¤šçº¿ç¨‹ç«äº‰CPUã€‚
        
    - **I/Oå¯†é›†å‹ä»»åŠ¡**ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œï¼‰ï¼šç”±äºçº¿ç¨‹ç»å¸¸ç­‰å¾…ï¼Œå¯ä»¥è®¾ç½®æ›´å¤§çš„ `corePoolSize`ï¼Œä¾‹å¦‚ **CPUæ ¸æ•° * 2**ï¼Œä»¥å……åˆ†åˆ©ç”¨ç­‰å¾…æ—¶é—´ã€‚`maximumPoolSize`å¯è®¾ä¸º `corePoolSize`çš„ 2-4 å€ã€‚
        
    
2. **é˜Ÿåˆ—é€‰æ‹©ä¸æ‹’ç»ç­–ç•¥è”åŠ¨**
    
    - ä½¿ç”¨**æœ‰ç•Œé˜Ÿåˆ—**ï¼ˆå¦‚ `ArrayBlockingQueue`ï¼‰æ—¶ï¼ŒåŠ¡å¿…è®¾ç½®åˆç†çš„æ‹’ç»ç­–ç•¥ã€‚è‹¥ä¸æƒ³ä¸¢å¼ƒä»»åŠ¡ï¼Œ`CallerRunsPolicy`æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œå®ƒä¼šè®©æäº¤ä»»åŠ¡çš„çº¿ç¨‹ç›´æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä»è€Œå‡ç¼“æ–°ä»»åŠ¡æäº¤é€Ÿåº¦ã€‚
        
    - ä½¿ç”¨**æ— ç•Œé˜Ÿåˆ—**ï¼ˆå¦‚æœªè®¾ç½®å®¹é‡çš„ `LinkedBlockingQueue`ï¼‰æ—¶ï¼Œ`maximumPoolSize`å‚æ•°ä¼šå¤±æ•ˆï¼Œå› ä¸ºä»»åŠ¡ä¼šä¸€ç›´åŠ å…¥é˜Ÿåˆ—ï¼Œä¸ä¼šåˆ›å»ºè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚éœ€è­¦æƒ•å†…å­˜æº¢å‡ºçš„é£é™©ã€‚
        
    
3. **ç»™çº¿ç¨‹èµ·ä¸ªå¥½åå­—**
    
    é€šè¿‡è‡ªå®šä¹‰ `ThreadFactory`è®¾ç½®æ¸…æ™°çš„çº¿ç¨‹åå‰ç¼€ï¼ˆå¦‚ `Download-Thread-`ï¼‰ï¼Œè¿™åœ¨æ—¥å¿—åˆ†ææˆ–ä½¿ç”¨ `jstack`ç­‰å·¥å…·æ’æŸ¥é—®é¢˜æ—¶éå¸¸æœ‰ç”¨ã€‚
    

### âš ï¸ æ³¨æ„äº‹é¡¹

- **åŠ¡å¿…æ˜¾å¼å…³é—­**ï¼šçº¿ç¨‹æ± ä½¿ç”¨å®Œæ¯•å¿…é¡»è°ƒç”¨ `shutdown()`è¿›è¡Œä¼˜é›…å…³é—­ï¼Œå¦åˆ™å³ä½¿ä¸»çº¿ç¨‹ç»“æŸï¼Œæ± ä¸­çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œå¯¼è‡´èµ„æºæ³„æ¼ã€‚
    
- **é¿å…ä½¿ç”¨é»˜è®¤æ— ç•Œé˜Ÿåˆ—**ï¼š`Executors.newFixedThreadPool`ä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œåœ¨ä»»åŠ¡ç”Ÿäº§é€Ÿåº¦è¿œå¤§äºæ¶ˆè´¹é€Ÿåº¦æ—¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ç›´æ¥ä½¿ç”¨ `ThreadPoolExecutor`æ„é€ å‡½æ•°ã€‚
    
- **è€ƒè™‘åŠ¨æ€è°ƒæ•´**ï¼š`ThreadPoolExecutor`å…è®¸é€šè¿‡ `setCorePoolSize()`ç­‰æ–¹æ³•åœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´å‚æ•°ï¼Œä»¥é€‚åº”æµé‡æ³¢åŠ¨ã€‚
    

å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¸®åŠ©ä½ æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯ï¼Œé…ç½®å‡ºé«˜æ•ˆå¯é çš„è‡ªå®šä¹‰çº¿ç¨‹æ± ã€‚å¦‚æœä½ å¯¹ç‰¹å®šåœºæ™¯ï¼ˆå¦‚é«˜å¹¶å‘æˆ–å®šæ—¶ä»»åŠ¡ï¼‰çš„é…ç½®æœ‰æ›´å¤šç–‘é—®ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ¢è®¨ã€‚